@startuml Settle_with_Central_Ledger

skinparam TitleFontSize 20
skinparam TitleFontColor #FFFFFF
skinparam titleBorderRoundCorner 10
skinparam titleBorderThickness 6
skinparam titleBorderColor #005B96
skinparam titleBackgroundColor #005B96
title Settlement from \nCentral-Ledger

participant "Central-Ledger" as ext_cl #C1C7C9
note over ext_cl
    Clears transactions &
    maintains liquidity balances
end note

box Settlements BC #F9FFF9
    participant "Rest API" as sbc_rest #F5FFF5
    participant "Event \nHandler" as sbc_event #F5FFF5
    participant "Settlements BC\nApp Logic" as sbc_app_logic #D2E5D3
    database "Settlements \nDatabase" as sbc_db #94C195
    participant "Ledger \nAdapter" as sbc_adptr #66A767
end box

group 1. Publish Cleared Transfers
autonumber
    ext_cl <--> ext_cl : Prepare transfer
    'ext_cl <--> ext_cl : **Transfer prepare**. \nObtain settlement model and allocation data\nvia Central-Ledger rules engine
    ext_cl <--> ext_cl : Obtain \nsettlement model
    ext_cl -> sbc_event : Fulfil & publish \ncleared transfers
    'ext_cl -> sbc_event : \n//publishEvent// will all necessary data as\n**//TransferPreparedEvtPayload//**
    sbc_event --> sbc_app_logic : Consume \npublished event
autonumber
    'sbc_app_logic -> sbc_event : Listen for Settlement Transfer event
end

group 2. Process Settlement Transfers
    sbc_app_logic --> sbc_app_logic: Trigger settlement &\nvalidate transfer data
    'sbc_app_logic <--> sbc_app_logic: Settlement Transfer event triggered\nconverted as **//ITransferDto//**
    sbc_app_logic -> ext_cl : Lookup settlement config
    sbc_app_logic <- ext_cl : Return settlement config
    'sbc_app_logic <--> sbc_db : Fetch & cache settlement config\n**Platform Config BC / Admin API**
    sbc_app_logic <--> sbc_db : Determine \nsettlement batch
    'sbc_app_logic <--> sbc_db : **Obtain open batch** based on Settlement Transfer data.\n//Create new batch if no OPEN batch available//
    sbc_app_logic -> sbc_adptr : Obtain settlement accounts
    sbc_app_logic <- sbc_adptr : Return settlement accounts
    sbc_app_logic -> sbc_adptr: Create settlement transfer
    sbc_app_logic <- sbc_adptr : Return transfer creation result
    sbc_app_logic <--> sbc_db : Persist complete \nsettlement transfer
    'sbc_app_logic <-> abbc_grpc : Obtain **Settlement accounts** using Participant account
    'sbc_app_logic <--> sbc_db : Create or fetch **Settlement Batch Account**
    'abbc_grpc -> sbc_app_logic : Return **Account** info
    'sbc_app_logic -> abbc_grpc: Create Settlement Transfer
    'abbc_grpc <-> abbc_tigerbeetle: Create Transfer: update accounts \nto DR payer & CR payee
    'abbc_grpc -> sbc_app_logic : Return **Transfer** creation info
    sbc_app_logic <-> sbc_app_logic: Prepare \nresponse data
    sbc_app_logic -> sbc_event : Return **Transfer** data
    ext_cl <- sbc_event  : Publish settled transfer event
end

@enduml
